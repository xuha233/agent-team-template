#!/usr/bin/env bash
# doctor - preflight checks for OpenClaw coding skill wrappers
set -euo pipefail

# Ensure standard tools are available on NixOS
export PATH="$PATH:/run/current-system/sw/bin"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "$SCRIPT_DIR/lib/resolve-cli.sh"

failures=0

check_cmd() {
  local name="$1"
  local remediation="$2"

  if command -v "$name" &>/dev/null; then
    printf '[ok] %s: %s\n' "$name" "$(command -v "$name")"
  else
    printf '[fail] %s: not found\n' "$name" >&2
    printf '       Fix: %s\n' "$remediation" >&2
    failures=$((failures + 1))
  fi
}

printf 'OpenClaw wrapper preflight\n'
printf '==========================\n'

check_cmd "codex" "npm install -g @openai/codex"
check_cmd "gh" "brew install gh"
check_cmd "timeout" "brew install coreutils && mkdir -p \"$HOME/.local/bin\" && ln -sf \"\$(brew --prefix coreutils)/bin/gtimeout\" \"$HOME/.local/bin/timeout\""

if claude_bin="$(resolve_claude_bin)"; then
  printf '[ok] claude: %s\n' "$claude_bin"
else
  if [[ -n "${CODING_AGENT_CLAUDE_BIN:-}" ]]; then
    printf '[fail] claude: CODING_AGENT_CLAUDE_BIN is set but not executable: %s\n' "${CODING_AGENT_CLAUDE_BIN}" >&2
    printf '       Fix: unset CODING_AGENT_CLAUDE_BIN or point it to a valid Claude binary\n' >&2
  else
    printf '[fail] claude: not found (checked CODING_AGENT_CLAUDE_BIN, ~/.claude/local/claude, then PATH)\n' >&2
    printf '       Fix (PATH install): npm install -g @anthropic-ai/claude-code\n' >&2
    printf '       Fix (local binary): install/use ~/.claude/local/claude\n' >&2
  fi
  failures=$((failures + 1))
fi

printf '[info] implementation mode default: %s (set CODING_AGENT_IMPL_MODE=direct|tmux|auto to override)\n' "${CODING_AGENT_IMPL_MODE:-direct}"

if [[ "$failures" -gt 0 ]]; then
  printf '\nPreflight failed with %s issue(s).\n' "$failures" >&2
  exit 1
fi

printf '\nPreflight passed.\n'
